
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../tutorials/svg.html">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Function reference - Distortions Reference Page</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#function-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="Distortions Reference Page" class="md-header__button md-logo" aria-label="Distortions Reference Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Distortions Reference Page
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Function reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="Distortions Reference Page" class="md-nav__button md-logo" aria-label="Distortions Reference Page" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Distortions Reference Page
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Articles
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Articles
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/pbmc.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PBMC Atlas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/mammoth.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Analyzing Fragmentation in a Flattened Mammoth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/c_elegans.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Comparing Density Preserving Algorithms on the C. Elegans Data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/custom_neighbors.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interacting with scDEED Flagged Neighborhoods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/hydra-80.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Comparing t-SNE Hyperparameters in the Hydra Atlas
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/fixed_transform.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding Isometrization with a Known Transformation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/two_clusters.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Density Preservation in a Gaussian Mixture Dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/link_data.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Analyzing Topology Failures with Interlocking Links
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/svg.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Saving Interactions as SVG
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="api.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Function reference
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="function-reference">Function Reference</h1>
<h1 id="api-reference">API Reference</h1>
<h2 id="distortionsgeometry"><code>distortions.geometry</code></h2>


<div class="doc doc-object doc-module">



<a id="distortions.geometry"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="distortions.geometry.Geometry" class="doc doc-heading">
            <code>Geometry</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="object">object</span></code></p>


        <p>The Geometry class stores the data, distance, affinity and laplacian
matrices used by the various embedding methods and is the primary
object passed to embedding functions.</p>
<p>The Geometry class contains functions to compute the aforementioned
matrices and allows for re-computation whenever necessary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_method</code>
            </td>
            <td>
                  <code>string {&#39;auto&#39;, &#39;brute&#39;, &#39;pyflann&#39;, &#39;cyflann&#39;}</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>method for computing pairwise radius neighbors graph.</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_kwds</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary containing keyword arguments for adjacency matrix.
see distance.py docmuentation for arguments for each method.
If new kwargs are passed to compute_adjacency_matrix then this
dictionary will be updated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>affinity_method</code>
            </td>
            <td>
                  <code>string {&#39;auto&#39;, &#39;gaussian&#39;}</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>method of computing affinity matrix</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>affinity_kwds</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary containing keyword arguments for affinity matrix.
see affinity.py documentation for arguments for each method.
If new kwargs are passed to compute_affinity_matrix then this
dictionary will be updated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>laplacian_method</code>
            </td>
            <td>
                  <code>(<span title="string">string</span>,)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>type of laplacian to be computed. Possibilities are
{'symmetricnormalized', 'geometric', 'renormalized',
'unnormalized', 'randomwalk'} see laplacian.py for more information.</p>
              </div>
            </td>
            <td>
                  <code>&#39;auto&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>laplacian_kwds</code>
            </td>
            <td>
                  <code><span title="dice">dice</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dictionary containing keyword arguments for Laplacian matrix.
see laplacian.py docmuentation for arguments for each method.
If new kwargs are passed to compute_laplacian_matrix then this
dictionary will be updated.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>additional arguments will be parsed and used to override values in
the above dictionaries. For example:
- <code>affinity_radius</code> will override <code>affinity_kwds['radius']</code>
- <code>adjacency_n_neighbors</code> will override <code>adjacency_kwds['n_neighbors']</code>
etc.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>







              <details class="quote">
                <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Geometry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Geometry class stores the data, distance, affinity and laplacian</span>
<span class="sd">    matrices used by the various embedding methods and is the primary</span>
<span class="sd">    object passed to embedding functions.</span>

<span class="sd">    The Geometry class contains functions to compute the aforementioned</span>
<span class="sd">    matrices and allows for re-computation whenever necessary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adjacency_method : string {&#39;auto&#39;, &#39;brute&#39;, &#39;pyflann&#39;, &#39;cyflann&#39;}</span>
<span class="sd">        method for computing pairwise radius neighbors graph.</span>
<span class="sd">    adjacency_kwds : dict</span>
<span class="sd">        dictionary containing keyword arguments for adjacency matrix.</span>
<span class="sd">        see distance.py docmuentation for arguments for each method.</span>
<span class="sd">        If new kwargs are passed to compute_adjacency_matrix then this</span>
<span class="sd">        dictionary will be updated.</span>
<span class="sd">    affinity_method : string {&#39;auto&#39;, &#39;gaussian&#39;}</span>
<span class="sd">        method of computing affinity matrix</span>
<span class="sd">    affinity_kwds : dict</span>
<span class="sd">        dictionary containing keyword arguments for affinity matrix.</span>
<span class="sd">        see affinity.py documentation for arguments for each method.</span>
<span class="sd">        If new kwargs are passed to compute_affinity_matrix then this</span>
<span class="sd">        dictionary will be updated.</span>
<span class="sd">    laplacian_method : string,</span>
<span class="sd">        type of laplacian to be computed. Possibilities are</span>
<span class="sd">        {&#39;symmetricnormalized&#39;, &#39;geometric&#39;, &#39;renormalized&#39;,</span>
<span class="sd">        &#39;unnormalized&#39;, &#39;randomwalk&#39;} see laplacian.py for more information.</span>
<span class="sd">    laplacian_kwds : dice</span>
<span class="sd">        dictionary containing keyword arguments for Laplacian matrix.</span>
<span class="sd">        see laplacian.py docmuentation for arguments for each method.</span>
<span class="sd">        If new kwargs are passed to compute_laplacian_matrix then this</span>
<span class="sd">        dictionary will be updated.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        additional arguments will be parsed and used to override values in</span>
<span class="sd">        the above dictionaries. For example:</span>
<span class="sd">        - `affinity_radius` will override `affinity_kwds[&#39;radius&#39;]`</span>
<span class="sd">        - `adjacency_n_neighbors` will override `adjacency_kwds[&#39;n_neighbors&#39;]`</span>
<span class="sd">        etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adjacency_method</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">adjacency_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">affinity_method</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">affinity_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">laplacian_method</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">laplacian_kwds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_method</span> <span class="o">=</span> <span class="n">adjacency_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">adjacency_kwds</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_method</span> <span class="o">=</span> <span class="n">affinity_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">affinity_kwds</span> <span class="ow">or</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_method</span> <span class="o">=</span> <span class="n">laplacian_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">laplacian_kwds</span> <span class="ow">or</span> <span class="p">{}))</span>

        <span class="c1"># map extra keywords: e.g. affinity_radius -&gt; affinity_kwds[&#39;radius&#39;]</span>
        <span class="n">dicts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">adjaceny</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="p">,</span>
                     <span class="n">affinity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="p">,</span>
                     <span class="n">laplacian</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">laplacian_kwds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">keysplit</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keysplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;key `</span><span class="si">{0}</span><span class="s1">` not valid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">dicts</span><span class="p">[</span><span class="n">keysplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keysplit</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_symmetric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_weights</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the radius for the adjacency and affinity computation</span>

<span class="sd">        By default, this will override keyword arguments provided on</span>
<span class="sd">        initialization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        radius : float</span>
<span class="sd">            radius to set for adjacency and affinity.</span>
<span class="sd">        override : bool (default: True)</span>
<span class="sd">            if False, then only set radius if not already defined in</span>
<span class="sd">            `adjacency_args` and `affinity_args`.</span>
<span class="sd">        X : ndarray or sparse (optional)</span>
<span class="sd">            if provided, estimate a suitable radius from this data.</span>
<span class="sd">        n_components : int (default=2)</span>
<span class="sd">            the number of components to use when estimating the radius</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;radius must be non-negative&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span> <span class="ow">and</span>
                        <span class="s1">&#39;n_neighbors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>

        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">input_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the data matrix given the input type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like</span>
<span class="sd">            Input matrix to set.</span>
<span class="sd">        input_type : str</span>
<span class="sd">            Type of matrix to set. Options: {&#39;data&#39;, &#39;adjacency&#39;, &#39;affinity&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;adjacency&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_adjacency_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;affinity&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_affinity_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized input_type: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_type</span><span class="p">))</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">compute_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will compute the adjacency matrix.</span>
<span class="sd">        In order to acquire the existing adjacency matrix use</span>
<span class="sd">        self.adjacency_matrix as comptute_adjacency_matrix() will re-compute</span>
<span class="sd">        the adjacency matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        copy : boolean, whether to return a copied version of the adjacency matrix</span>
<span class="sd">        **kwargs : see distance.py docmuentation for arguments for each method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.adjacency_matrix : sparse matrix (N_obs, N_obs)</span>
<span class="sd">            Non explicit 0.0 values should be considered not connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">distance_error_msg</span><span class="p">)</span>

        <span class="n">kwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">compute_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_method</span><span class="p">,</span>
                                                         <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will compute the affinity matrix. In order to</span>
<span class="sd">        acquire the existing affinity matrix use self.affinity_matrix as</span>
<span class="sd">        comptute_affinity_matrix() will re-compute the affinity matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        copy : boolean</span>
<span class="sd">            whether to return a copied version of the affinity matrix</span>
<span class="sd">        **kwargs :</span>
<span class="sd">            see affinity.py docmuentation for arguments for each method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.affinity_matrix : sparse matrix (N_obs, N_obs)</span>
<span class="sd">            contains the pairwise affinity values using the Guassian kernel</span>
<span class="sd">            and bandwidth equal to the affinity_radius</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_adjacency_matrix</span><span class="p">()</span>

        <span class="n">kwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="n">compute_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">affinity_method</span><span class="p">,</span>
                                                       <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_lapsym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note: this function will compute the laplacian matrix. In order to acquire</span>
<span class="sd">            the existing laplacian matrix use self.laplacian_matrix as</span>
<span class="sd">            compute_laplacian_matrix() will re-compute the laplacian matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        copy : boolean, whether to return copied version of the self.laplacian_matrix</span>
<span class="sd">        return_lapsym : boolean, if True returns additionally the symmetrized version of</span>
<span class="sd">            the requested laplacian and the re-normalization weights.</span>
<span class="sd">        **kwargs : see laplacian.py docmuentation for arguments for each method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.laplacian_matrix : sparse matrix (N_obs, N_obs).</span>
<span class="sd">            The requested laplacian.</span>
<span class="sd">        self.laplacian_symmetric : sparse matrix (N_obs, N_obs)</span>
<span class="sd">            The symmetric laplacian.</span>
<span class="sd">        self.laplacian_weights : ndarray (N_obs,)</span>
<span class="sd">            The renormalization weights used to make</span>
<span class="sd">            laplacian_matrix from laplacian_symmetric</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_affinity_matrix</span><span class="p">()</span>

        <span class="n">kwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_kwds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;full_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_lapsym</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_method</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_lapsym</span><span class="p">:</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_symmetric</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_weights</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_data_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the data matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : array-like, shape (n_samples, n_features)</span>
<span class="sd">            The original data set to input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#X = check_array(X, accept_sparse=sparse_formats)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adjacency_mat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the adjacency matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        adjacency_mat : sparse matrix, shape (n_samples, n_samples)</span>
<span class="sd">            The adjacency matrix to input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#adjacency_mat = check_array(adjacency_mat, accept_sparse=sparse_formats)</span>
        <span class="k">if</span> <span class="n">adjacency_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">adjacency_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;adjacency matrix is not square&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">adjacency_mat</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affinity_mat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the affinity matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        affinity_mat : sparse matrix (N_obs, N_obs).</span>
<span class="sd">            The adjacency matrix to input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#affinity_mat = check_array(affinity_mat, accept_sparse=sparse_formats)</span>
        <span class="k">if</span> <span class="n">affinity_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">affinity_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;affinity matrix is not square&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="n">affinity_mat</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laplacian_mat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Laplacian matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        laplacian_mat : sparse matrix (N_obs, N_obs).</span>
<span class="sd">            The Laplacian matrix to input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#laplacian_mat = check_array(laplacian_mat, accept_sparse = sparse_formats)</span>
        <span class="k">if</span> <span class="n">laplacian_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">laplacian_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Laplacian matrix is not square&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="n">laplacian_mat</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_data_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the data matrix from the Geometry object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the adjacency matrix from the Geometry object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the affinity matrix from the Geometry object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete the Laplacian matrix from the Geometry object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.compute_adjacency_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_adjacency_matrix</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function will compute the adjacency matrix.
In order to acquire the existing adjacency matrix use
self.adjacency_matrix as comptute_adjacency_matrix() will re-compute
the adjacency matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>copy</code>
            </td>
            <td>
                  <code>boolean, whether to return a copied version of the adjacency matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>see distance.py docmuentation for arguments for each method.</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>self.adjacency_matrix : sparse matrix (N_obs, N_obs)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Non explicit 0.0 values should be considered not connected.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will compute the adjacency matrix.</span>
<span class="sd">    In order to acquire the existing adjacency matrix use</span>
<span class="sd">    self.adjacency_matrix as comptute_adjacency_matrix() will re-compute</span>
<span class="sd">    the adjacency matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    copy : boolean, whether to return a copied version of the adjacency matrix</span>
<span class="sd">    **kwargs : see distance.py docmuentation for arguments for each method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    self.adjacency_matrix : sparse matrix (N_obs, N_obs)</span>
<span class="sd">        Non explicit 0.0 values should be considered not connected.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">distance_error_msg</span><span class="p">)</span>

    <span class="n">kwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">compute_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_method</span><span class="p">,</span>
                                                     <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.compute_affinity_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_affinity_matrix</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>This function will compute the affinity matrix. In order to
acquire the existing affinity matrix use self.affinity_matrix as
comptute_affinity_matrix() will re-compute the affinity matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>copy</code>
            </td>
            <td>
                  <code><span title="boolean">boolean</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>whether to return a copied version of the affinity matrix</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>see affinity.py docmuentation for arguments for each method.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>self.affinity_matrix : sparse matrix (N_obs, N_obs)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>contains the pairwise affinity values using the Guassian kernel
and bandwidth equal to the affinity_radius</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will compute the affinity matrix. In order to</span>
<span class="sd">    acquire the existing affinity matrix use self.affinity_matrix as</span>
<span class="sd">    comptute_affinity_matrix() will re-compute the affinity matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    copy : boolean</span>
<span class="sd">        whether to return a copied version of the affinity matrix</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        see affinity.py docmuentation for arguments for each method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    self.affinity_matrix : sparse matrix (N_obs, N_obs)</span>
<span class="sd">        contains the pairwise affinity values using the Guassian kernel</span>
<span class="sd">        and bandwidth equal to the affinity_radius</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_adjacency_matrix</span><span class="p">()</span>

    <span class="n">kwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="n">compute_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">affinity_method</span><span class="p">,</span>
                                                   <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.compute_laplacian_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_laplacian_matrix</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_lapsym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Note: this function will compute the laplacian matrix. In order to acquire
    the existing laplacian matrix use self.laplacian_matrix as
    compute_laplacian_matrix() will re-compute the laplacian matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>copy</code>
            </td>
            <td>
                  <code>boolean, whether to return copied version of the self.laplacian_matrix</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>return_lapsym</code>
            </td>
            <td>
                  <code>boolean, if True returns additionally the symmetrized version of</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the requested laplacian and the re-normalization weights.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>see laplacian.py docmuentation for arguments for each method.</code>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>self.laplacian_matrix : sparse matrix (N_obs, N_obs).</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The requested laplacian.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>self.laplacian_symmetric : sparse matrix (N_obs, N_obs)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The symmetric laplacian.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code>self.laplacian_weights : ndarray (N_obs,)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The renormalization weights used to make
laplacian_matrix from laplacian_symmetric</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_lapsym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Note: this function will compute the laplacian matrix. In order to acquire</span>
<span class="sd">        the existing laplacian matrix use self.laplacian_matrix as</span>
<span class="sd">        compute_laplacian_matrix() will re-compute the laplacian matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    copy : boolean, whether to return copied version of the self.laplacian_matrix</span>
<span class="sd">    return_lapsym : boolean, if True returns additionally the symmetrized version of</span>
<span class="sd">        the requested laplacian and the re-normalization weights.</span>
<span class="sd">    **kwargs : see laplacian.py docmuentation for arguments for each method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    self.laplacian_matrix : sparse matrix (N_obs, N_obs).</span>
<span class="sd">        The requested laplacian.</span>
<span class="sd">    self.laplacian_symmetric : sparse matrix (N_obs, N_obs)</span>
<span class="sd">        The symmetric laplacian.</span>
<span class="sd">    self.laplacian_weights : ndarray (N_obs,)</span>
<span class="sd">        The renormalization weights used to make</span>
<span class="sd">        laplacian_matrix from laplacian_symmetric</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_affinity_matrix</span><span class="p">()</span>

    <span class="n">kwds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_kwds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;full_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">return_lapsym</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">compute_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_method</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_lapsym</span><span class="p">:</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_symmetric</span><span class="p">,</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_weights</span><span class="p">)</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.delete_adjacency_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_adjacency_matrix</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Delete the adjacency matrix from the Geometry object.</p>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the adjacency matrix from the Geometry object.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.delete_affinity_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_affinity_matrix</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Delete the affinity matrix from the Geometry object.</p>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the affinity matrix from the Geometry object.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.delete_data_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_data_matrix</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Delete the data matrix from the Geometry object.</p>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete_data_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the data matrix from the Geometry object.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.delete_laplacian_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">delete_laplacian_matrix</span><span class="p">()</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Delete the Laplacian matrix from the Geometry object.</p>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">delete_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete the Laplacian matrix from the Geometry object.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.set_adjacency_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_adjacency_matrix</span><span class="p">(</span><span class="n">adjacency_mat</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the adjacency matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adjacency_mat</code>
            </td>
            <td>
                  <code>sparse matrix, shape (n_samples, n_samples)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The adjacency matrix to input.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adjacency_mat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the adjacency matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adjacency_mat : sparse matrix, shape (n_samples, n_samples)</span>
<span class="sd">        The adjacency matrix to input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#adjacency_mat = check_array(adjacency_mat, accept_sparse=sparse_formats)</span>
    <span class="k">if</span> <span class="n">adjacency_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">adjacency_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;adjacency matrix is not square&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">adjacency_mat</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.set_affinity_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_affinity_matrix</span><span class="p">(</span><span class="n">affinity_mat</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the affinity matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>affinity_mat</code>
            </td>
            <td>
                  <code>sparse matrix (N_obs, N_obs).</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The adjacency matrix to input.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_affinity_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">affinity_mat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the affinity matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    affinity_mat : sparse matrix (N_obs, N_obs).</span>
<span class="sd">        The adjacency matrix to input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#affinity_mat = check_array(affinity_mat, accept_sparse=sparse_formats)</span>
    <span class="k">if</span> <span class="n">affinity_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">affinity_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;affinity matrix is not square&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">affinity_matrix</span> <span class="o">=</span> <span class="n">affinity_mat</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.set_data_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_data_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the data matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code>(<span title="array">array</span> - <span title="like">like</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_features">n_features</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original data set to input.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_data_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the data matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : array-like, shape (n_samples, n_features)</span>
<span class="sd">        The original data set to input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#X = check_array(X, accept_sparse=sparse_formats)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.set_laplacian_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_laplacian_matrix</span><span class="p">(</span><span class="n">laplacian_mat</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the Laplacian matrix.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>laplacian_mat</code>
            </td>
            <td>
                  <code>sparse matrix (N_obs, N_obs).</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Laplacian matrix to input.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_laplacian_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">laplacian_mat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the Laplacian matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    laplacian_mat : sparse matrix (N_obs, N_obs).</span>
<span class="sd">        The Laplacian matrix to input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#laplacian_mat = check_array(laplacian_mat, accept_sparse = sparse_formats)</span>
    <span class="k">if</span> <span class="n">laplacian_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">laplacian_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Laplacian matrix is not square&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">laplacian_matrix</span> <span class="o">=</span> <span class="n">laplacian_mat</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.set_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">input_type</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the data matrix given the input type.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input matrix to set.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>input_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of matrix to set. Options: {'data', 'adjacency', 'affinity'}</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">input_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the data matrix given the input type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : array-like</span>
<span class="sd">        Input matrix to set.</span>
<span class="sd">    input_type : str</span>
<span class="sd">        Type of matrix to set. Options: {&#39;data&#39;, &#39;adjacency&#39;, &#39;affinity&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;adjacency&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_adjacency_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s1">&#39;affinity&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_affinity_matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized input_type: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">input_type</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.Geometry.set_radius" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_radius</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Set the radius for the adjacency and affinity computation</p>
<p>By default, this will override keyword arguments provided on
initialization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>radius</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>radius to set for adjacency and affinity.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>override</code>
            </td>
            <td>
                  <code>bool (default: True)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if False, then only set radius if not already defined in
<code>adjacency_args</code> and <code>affinity_args</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>X</code>
            </td>
            <td>
                  <code><span title="ndarray">ndarray</span> or <span title="sparse">sparse</span>(<span title="optional">optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if provided, estimate a suitable radius from this data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_components</code>
            </td>
            <td>
                  <code><span title="int">int</span>(default=2)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the number of components to use when estimating the radius</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/geometry.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the radius for the adjacency and affinity computation</span>

<span class="sd">    By default, this will override keyword arguments provided on</span>
<span class="sd">    initialization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius : float</span>
<span class="sd">        radius to set for adjacency and affinity.</span>
<span class="sd">    override : bool (default: True)</span>
<span class="sd">        if False, then only set radius if not already defined in</span>
<span class="sd">        `adjacency_args` and `affinity_args`.</span>
<span class="sd">    X : ndarray or sparse (optional)</span>
<span class="sd">        if provided, estimate a suitable radius from this data.</span>
<span class="sd">    n_components : int (default=2)</span>
<span class="sd">        the number of components to use when estimating the radius</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;radius must be non-negative&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span> <span class="ow">and</span>
                    <span class="s1">&#39;n_neighbors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_kwds</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>

    <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">affinity_kwds</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="distortions.geometry.bind_metric" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">bind_metric</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">Hvv</span><span class="p">,</span> <span class="n">Hs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Combine embedding coordinates with local Riemannian metric information.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_embedding_dims">n_embedding_dims</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The low-dimensional embedding of the data. This should be the same array
as the <code>embedding</code> argument passed to <code>local_distortions</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Hvv</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_embedding_dims">n_embedding_dims</span>, <span title="n_embedding_dims">n_embedding_dims</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The singular vectors of the dual Riemannian metric tensor for each sample,
as returned by <code>local_distortions</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Hs</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_embedding_dims">n_embedding_dims</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The singular values of the dual Riemannian metric tensor for each sample,
as returned by <code>local_distortions</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>combined</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DataFrame containing the embedding coordinates, the singular vectors and
singular values of the local dual Riemannian metric for each sample, and
an additional column "angle" computed from the first two singular vector
components.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function is intended to facilitate analysis and visualization by merging
the embedding and local metric information into a single tabular structure.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>distortions/geometry/rmetric.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">bind_metric</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">Hvv</span><span class="p">,</span> <span class="n">Hs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine embedding coordinates with local Riemannian metric information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embedding : np.ndarray, shape (n_samples, n_embedding_dims)</span>
<span class="sd">        The low-dimensional embedding of the data. This should be the same array</span>
<span class="sd">        as the `embedding` argument passed to `local_distortions`.</span>
<span class="sd">    Hvv : np.ndarray, shape (n_samples, n_embedding_dims, n_embedding_dims)</span>
<span class="sd">        The singular vectors of the dual Riemannian metric tensor for each sample,</span>
<span class="sd">        as returned by `local_distortions`.</span>
<span class="sd">    Hs : np.ndarray, shape (n_samples, n_embedding_dims)</span>
<span class="sd">        The singular values of the dual Riemannian metric tensor for each sample,</span>
<span class="sd">        as returned by `local_distortions`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    combined : pd.DataFrame</span>
<span class="sd">        A DataFrame containing the embedding coordinates, the singular vectors and</span>
<span class="sd">        singular values of the local dual Riemannian metric for each sample, and</span>
<span class="sd">        an additional column &quot;angle&quot; computed from the first two singular vector</span>
<span class="sd">        components.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is intended to facilitate analysis and visualization by merging</span>
<span class="sd">    the embedding and local metric information into a single tabular structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">embedding</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Hvv_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">arrays_to_df</span><span class="p">(</span><span class="n">Hvv</span><span class="p">),</span> <span class="n">arrays_to_df</span><span class="p">(</span><span class="n">Hs</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">embedding_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;embedding_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)])</span>
    <span class="n">embedding_df</span> <span class="o">=</span> <span class="n">embedding_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Hvv_df</span> <span class="o">=</span> <span class="n">Hvv_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># merge the embedding and metric data</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">embedding_df</span><span class="p">,</span> <span class="n">Hvv_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">metric_columns</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)],</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)]</span>
    <span class="n">combined</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">embedding_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="n">metric_columns</span>
    <span class="n">combined</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">combined</span><span class="o">.</span><span class="n">y1</span> <span class="o">/</span> <span class="n">combined</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combined</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="distortions.geometry.boxplot_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">boxplot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">outlier_iqr</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute boxplot statistics and identify outliers within distance bins.</p>
<p>This function divides the x-values (typically true distances) into bins and
computes boxplot statistics for the y-values (typically embedding distances)
within each bin. It identifies outliers using the IQR method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input values used for binning (typically true/original distances).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target values for which to compute statistics (typically embedding distances).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbin</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins to divide the x-value range into.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_iqr</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IQR multiplier for outlier detection. Values beyond Q1 - outlier_iqr<em>IQR
or Q3 + outlier_iqr</em>IQR within each bin are considered outliers.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>keyword arguments</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>summaries</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with boxplot statistics for each bin containing columns:
- 'bin_id': bin identifier
- 'q1', 'q2', 'q3': quartile values
- 'min', 'max': minimum and maximum values
- 'iqr': interquartile range
- 'lower', 'upper': outlier detection bounds
- 'bin': string representation of bin range</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>outliers</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with outlier information containing columns:
- 'index': original index of outlier point
- 'bin_id': which bin the outlier belongs to
- 'bin': string representation of bin range
- 'value': the outlier y-value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">boxplot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">outlier_iqr</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute boxplot statistics and identify outliers within distance bins.</span>

<span class="sd">    This function divides the x-values (typically true distances) into bins and</span>
<span class="sd">    computes boxplot statistics for the y-values (typically embedding distances)</span>
<span class="sd">    within each bin. It identifies outliers using the IQR method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array-like</span>
<span class="sd">        Input values used for binning (typically true/original distances).</span>
<span class="sd">    y : array-like</span>
<span class="sd">        Target values for which to compute statistics (typically embedding distances).</span>
<span class="sd">    nbin : int, default=10</span>
<span class="sd">        Number of bins to divide the x-value range into.</span>
<span class="sd">    outlier_iqr : float, default=3</span>
<span class="sd">        IQR multiplier for outlier detection. Values beyond Q1 - outlier_iqr*IQR</span>
<span class="sd">        or Q3 + outlier_iqr*IQR within each bin are considered outliers.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    summaries : pd.DataFrame</span>
<span class="sd">        DataFrame with boxplot statistics for each bin containing columns:</span>
<span class="sd">        - &#39;bin_id&#39;: bin identifier</span>
<span class="sd">        - &#39;q1&#39;, &#39;q2&#39;, &#39;q3&#39;: quartile values</span>
<span class="sd">        - &#39;min&#39;, &#39;max&#39;: minimum and maximum values</span>
<span class="sd">        - &#39;iqr&#39;: interquartile range</span>
<span class="sd">        - &#39;lower&#39;, &#39;upper&#39;: outlier detection bounds</span>
<span class="sd">        - &#39;bin&#39;: string representation of bin range</span>
<span class="sd">    outliers : pd.DataFrame  </span>
<span class="sd">        DataFrame with outlier information containing columns:</span>
<span class="sd">        - &#39;index&#39;: original index of outlier point</span>
<span class="sd">        - &#39;bin_id&#39;: which bin the outlier belongs to</span>
<span class="sd">        - &#39;bin&#39;: string representation of bin range</span>
<span class="sd">        - &#39;value&#39;: the outlier y-value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># divide the data into nbin groups, and compute quantiles in each</span>
    <span class="n">bin_ids</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">summaries</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;bin_id&#39;</span><span class="p">:</span> <span class="n">bin_ids</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">q1</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
             <span class="n">q2</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
             <span class="n">q3</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
             <span class="nb">min</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;iqr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summaries</span><span class="o">.</span><span class="n">q3</span> <span class="o">-</span> <span class="n">summaries</span><span class="o">.</span><span class="n">q1</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">summaries</span><span class="o">.</span><span class="n">q2</span> <span class="o">-</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">iqr</span><span class="p">,</span> <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">summaries</span><span class="o">.</span><span class="n">q2</span> <span class="o">+</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">iqr</span><span class="p">,</span> <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;bin_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># compute outliers according to the IQR above</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;bin_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s2">&quot;bin&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bin_ids</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">val</span> <span class="o">&lt;</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;q1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;iqr&#39;</span><span class="p">]</span> <span class="ow">or</span>
            <span class="n">val</span> <span class="o">&gt;</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;iqr&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="distortions.geometry.local_distortions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_distortions</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute local Riemannian metric distortions for each sample.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_embedding_dims">n_embedding_dims</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Low-dimensional embedding of the data. Each row corresponds to a sample,
and each column corresponds to an embedding dimension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_features">n_features</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original high-dimensional data. Each row is a sample, each column a feature.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>geom</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Geometry (distortions.geometry.geometry.Geometry)" href="#distortions.geometry.Geometry">Geometry</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the Geometry class (from geometry.py) that provides
methods for setting the data matrix and computing the Laplacian matrix.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>H</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dual Riemannian metric tensor for each sample.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>Hvv</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Singular vectors of the dual metric tensor for each sample.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>Hs</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Singular values of the dual metric tensor for each sample.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function sets the data matrix in the provided Geometry object,
computes the Laplacian matrix, and then estimates the local Riemannian
metric distortions in the embedding space using the original data.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>distortions/geometry/rmetric.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">local_distortions</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute local Riemannian metric distortions for each sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embedding : np.ndarray, shape (n_samples, n_embedding_dims)</span>
<span class="sd">        Low-dimensional embedding of the data. Each row corresponds to a sample,</span>
<span class="sd">        and each column corresponds to an embedding dimension.</span>
<span class="sd">    data : np.ndarray, shape (n_samples, n_features)</span>
<span class="sd">        Original high-dimensional data. Each row is a sample, each column a feature.</span>
<span class="sd">    geom : Geometry</span>
<span class="sd">        An instance of the Geometry class (from geometry.py) that provides</span>
<span class="sd">        methods for setting the data matrix and computing the Laplacian matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    H : np.ndarray</span>
<span class="sd">        Dual Riemannian metric tensor for each sample.</span>
<span class="sd">    Hvv : np.ndarray</span>
<span class="sd">        Singular vectors of the dual metric tensor for each sample.</span>
<span class="sd">    Hs : np.ndarray</span>
<span class="sd">        Singular values of the dual metric tensor for each sample.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function sets the data matrix in the provided Geometry object,</span>
<span class="sd">    computes the Laplacian matrix, and then estimates the local Riemannian</span>
<span class="sd">    metric distortions in the embedding space using the original data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">set_data_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">compute_laplacian_matrix</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Hvv</span><span class="p">,</span> <span class="n">Hs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">riemann_metric</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">n_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">Hvv</span><span class="p">,</span> <span class="n">Hs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="distortions.geometry.neighborhood_distances" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neighborhood_distances</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">embed_key</span><span class="o">=</span><span class="s1">&#39;X_umap&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute pairwise distances between samples and their neighbors in both original and embedding spaces.</p>
<p>This function calculates pairwise distances between each sample and its
neighbors in the original high-dimensional space and compares them with
distances in the reduced embedding space. This is useful for analyzing
how well the embedding preserves local neighborhood structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adata</code>
            </td>
            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Annotated data matrix. Must contain a precomputed embedding (e.g., UMAP or t-SNE) in <code>obsm[embed_key]</code>
and a neighbor graph in <code>obsp["distances"]</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>embed_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key in <code>adata.obsm</code> where the embedding coordinates are stored.</p>
              </div>
            </td>
            <td>
                  <code>&#34;X_umap&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with columns:
    - 'center': index of the sample (cell)
    - 'neighbor': index of the neighbor sample
    - 'true': distance in the original space (from <code>adata.obsp["distances"]</code>)
    - 'embedding': distance in the embedding space (from <code>adata.obsm[embed_key]</code>)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The number of neighbors is determined by the structure of the neighbor graph in <code>adata.obsp["distances"]</code>.
The function assumes that the embedding and neighbor graph have already been computed.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neighborhood_distances</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">embed_key</span><span class="o">=</span><span class="s2">&quot;X_umap&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute pairwise distances between samples and their neighbors in both original and embedding spaces.</span>

<span class="sd">    This function calculates pairwise distances between each sample and its</span>
<span class="sd">    neighbors in the original high-dimensional space and compares them with</span>
<span class="sd">    distances in the reduced embedding space. This is useful for analyzing</span>
<span class="sd">    how well the embedding preserves local neighborhood structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix. Must contain a precomputed embedding (e.g., UMAP or t-SNE) in `obsm[embed_key]`</span>
<span class="sd">        and a neighbor graph in `obsp[&quot;distances&quot;]`.</span>
<span class="sd">    embed_key : str, default=&quot;X_umap&quot;</span>
<span class="sd">        Key in `adata.obsm` where the embedding coordinates are stored.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame with columns:</span>
<span class="sd">            - &#39;center&#39;: index of the sample (cell)</span>
<span class="sd">            - &#39;neighbor&#39;: index of the neighbor sample</span>
<span class="sd">            - &#39;true&#39;: distance in the original space (from `adata.obsp[&quot;distances&quot;]`)</span>
<span class="sd">            - &#39;embedding&#39;: distance in the embedding space (from `adata.obsm[embed_key]`)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The number of neighbors is determined by the structure of the neighbor graph in `adata.obsp[&quot;distances&quot;]`.</span>
<span class="sd">    The function assumes that the embedding and neighbor graph have already been computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knn_graph</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
    <span class="n">dist_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="p">)):</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">knn_graph</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">knn_graph</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span>
            <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">embed_key</span><span class="p">][</span><span class="n">ix</span><span class="p">,</span> <span class="p">:]],</span> 
            <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">embed_key</span><span class="p">][</span><span class="n">neighbors</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">),</span> 
            <span class="s2">&quot;neighbor&quot;</span><span class="p">:</span> <span class="n">neighbors</span><span class="p">,</span>
            <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
            <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">embedding</span>
        <span class="p">}))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dist_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="distortions.geometry.local_distortions" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">local_distortions</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Compute local Riemannian metric distortions for each sample.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_embedding_dims">n_embedding_dims</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Low-dimensional embedding of the data. Each row corresponds to a sample,
and each column corresponds to an embedding dimension.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code>(<span title="numpy.ndarray">ndarray</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_features">n_features</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Original high-dimensional data. Each row is a sample, each column a feature.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>geom</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Geometry (distortions.geometry.geometry.Geometry)" href="#distortions.geometry.Geometry">Geometry</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the Geometry class (from geometry.py) that provides
methods for setting the data matrix and computing the Laplacian matrix.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>H</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dual Riemannian metric tensor for each sample.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>Hvv</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Singular vectors of the dual metric tensor for each sample.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>Hs</code></td>            <td>
                  <code><span title="numpy.ndarray">ndarray</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Singular values of the dual metric tensor for each sample.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>This function sets the data matrix in the provided Geometry object,
computes the Laplacian matrix, and then estimates the local Riemannian
metric distortions in the embedding space using the original data.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>distortions/geometry/rmetric.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">local_distortions</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute local Riemannian metric distortions for each sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embedding : np.ndarray, shape (n_samples, n_embedding_dims)</span>
<span class="sd">        Low-dimensional embedding of the data. Each row corresponds to a sample,</span>
<span class="sd">        and each column corresponds to an embedding dimension.</span>
<span class="sd">    data : np.ndarray, shape (n_samples, n_features)</span>
<span class="sd">        Original high-dimensional data. Each row is a sample, each column a feature.</span>
<span class="sd">    geom : Geometry</span>
<span class="sd">        An instance of the Geometry class (from geometry.py) that provides</span>
<span class="sd">        methods for setting the data matrix and computing the Laplacian matrix.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    H : np.ndarray</span>
<span class="sd">        Dual Riemannian metric tensor for each sample.</span>
<span class="sd">    Hvv : np.ndarray</span>
<span class="sd">        Singular vectors of the dual metric tensor for each sample.</span>
<span class="sd">    Hs : np.ndarray</span>
<span class="sd">        Singular values of the dual metric tensor for each sample.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function sets the data matrix in the provided Geometry object,</span>
<span class="sd">    computes the Laplacian matrix, and then estimates the local Riemannian</span>
<span class="sd">    metric distortions in the embedding space using the original data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">geom</span><span class="o">.</span><span class="n">set_data_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">compute_laplacian_matrix</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Hvv</span><span class="p">,</span> <span class="n">Hs</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="n">riemann_metric</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">n_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">Hvv</span><span class="p">,</span> <span class="n">Hs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>


<div class="doc doc-object doc-module">



<h2 id="distortions.geometry.neighborhoods" class="doc doc-heading">
            <code>neighborhoods</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.boxplot_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">boxplot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">outlier_iqr</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute boxplot statistics and identify outliers within distance bins.</p>
<p>This function divides the x-values (typically true distances) into bins and
computes boxplot statistics for the y-values (typically embedding distances)
within each bin. It identifies outliers using the IQR method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input values used for binning (typically true/original distances).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>y</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target values for which to compute statistics (typically embedding distances).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbin</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins to divide the x-value range into.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_iqr</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IQR multiplier for outlier detection. Values beyond Q1 - outlier_iqr<em>IQR
or Q3 + outlier_iqr</em>IQR within each bin are considered outliers.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>keyword arguments</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments (currently unused).</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>summaries</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with boxplot statistics for each bin containing columns:
- 'bin_id': bin identifier
- 'q1', 'q2', 'q3': quartile values
- 'min', 'max': minimum and maximum values
- 'iqr': interquartile range
- 'lower', 'upper': outlier detection bounds
- 'bin': string representation of bin range</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>outliers</code></td>            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with outlier information containing columns:
- 'index': original index of outlier point
- 'bin_id': which bin the outlier belongs to
- 'bin': string representation of bin range
- 'value': the outlier y-value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">boxplot_data</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">outlier_iqr</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute boxplot statistics and identify outliers within distance bins.</span>

<span class="sd">    This function divides the x-values (typically true distances) into bins and</span>
<span class="sd">    computes boxplot statistics for the y-values (typically embedding distances)</span>
<span class="sd">    within each bin. It identifies outliers using the IQR method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array-like</span>
<span class="sd">        Input values used for binning (typically true/original distances).</span>
<span class="sd">    y : array-like</span>
<span class="sd">        Target values for which to compute statistics (typically embedding distances).</span>
<span class="sd">    nbin : int, default=10</span>
<span class="sd">        Number of bins to divide the x-value range into.</span>
<span class="sd">    outlier_iqr : float, default=3</span>
<span class="sd">        IQR multiplier for outlier detection. Values beyond Q1 - outlier_iqr*IQR</span>
<span class="sd">        or Q3 + outlier_iqr*IQR within each bin are considered outliers.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Additional keyword arguments (currently unused).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    summaries : pd.DataFrame</span>
<span class="sd">        DataFrame with boxplot statistics for each bin containing columns:</span>
<span class="sd">        - &#39;bin_id&#39;: bin identifier</span>
<span class="sd">        - &#39;q1&#39;, &#39;q2&#39;, &#39;q3&#39;: quartile values</span>
<span class="sd">        - &#39;min&#39;, &#39;max&#39;: minimum and maximum values</span>
<span class="sd">        - &#39;iqr&#39;: interquartile range</span>
<span class="sd">        - &#39;lower&#39;, &#39;upper&#39;: outlier detection bounds</span>
<span class="sd">        - &#39;bin&#39;: string representation of bin range</span>
<span class="sd">    outliers : pd.DataFrame  </span>
<span class="sd">        DataFrame with outlier information containing columns:</span>
<span class="sd">        - &#39;index&#39;: original index of outlier point</span>
<span class="sd">        - &#39;bin_id&#39;: which bin the outlier belongs to</span>
<span class="sd">        - &#39;bin&#39;: string representation of bin range</span>
<span class="sd">        - &#39;value&#39;: the outlier y-value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># divide the data into nbin groups, and compute quantiles in each</span>
    <span class="n">bin_ids</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">retbins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">summaries</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;bin_id&#39;</span><span class="p">:</span> <span class="n">bin_ids</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;bin_id&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
        <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">q1</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span>
             <span class="n">q2</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
             <span class="n">q3</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">75</span><span class="p">),</span>
             <span class="nb">min</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;iqr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summaries</span><span class="o">.</span><span class="n">q3</span> <span class="o">-</span> <span class="n">summaries</span><span class="o">.</span><span class="n">q1</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">summaries</span><span class="o">.</span><span class="n">q2</span> <span class="o">-</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">iqr</span><span class="p">,</span> <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">summaries</span><span class="o">.</span><span class="n">q2</span> <span class="o">+</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">iqr</span><span class="p">,</span> <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span>
    <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summaries</span><span class="p">[</span><span class="s1">&#39;bin_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># compute outliers according to the IQR above</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;bin_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s2">&quot;bin&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">bin_edges</span><span class="p">[</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">bin_ids</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">val</span> <span class="o">&lt;</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;q1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;iqr&#39;</span><span class="p">]</span> <span class="ow">or</span>
            <span class="n">val</span> <span class="o">&gt;</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">outlier_iqr</span> <span class="o">*</span> <span class="n">summaries</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;iqr&#39;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.broken_knn" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">broken_knn</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_thresh</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Determine broken points in embedding space using k-NN distances and Z-score thresholding.</p>
<p>This function identifies potentially problematic points in an embedding by
computing their average k-nearest neighbor distances, calculating Z-scores,
and flagging points that exceed the threshold as broken or isolated.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code>(<span title="array">array</span> - <span title="like">like</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_features">n_features</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedding coordinates for all samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of nearest neighbors to consider for distance calculation.</p>
              </div>
            </td>
            <td>
                  <code>2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>z_thresh</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Z-score threshold for identifying broken points. Points with Z-scores
greater than or equal to this value are considered broken.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices of broken points, sorted by descending Z-score.
If no points exceed the threshold, returns the single point with
the highest Z-score.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">broken_knn</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">z_thresh</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine broken points in embedding space using k-NN distances and Z-score thresholding.</span>

<span class="sd">    This function identifies potentially problematic points in an embedding by</span>
<span class="sd">    computing their average k-nearest neighbor distances, calculating Z-scores,</span>
<span class="sd">    and flagging points that exceed the threshold as broken or isolated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embedding : array-like, shape (n_samples, n_features)</span>
<span class="sd">        The embedding coordinates for all samples.</span>
<span class="sd">    k : int, default=2</span>
<span class="sd">        Number of nearest neighbors to consider for distance calculation.</span>
<span class="sd">    z_thresh : float, default=1.0</span>
<span class="sd">        Z-score threshold for identifying broken points. Points with Z-scores</span>
<span class="sd">        greater than or equal to this value are considered broken.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of int</span>
<span class="sd">        List of indices of broken points, sorted by descending Z-score.</span>
<span class="sd">        If no points exceed the threshold, returns the single point with</span>
<span class="sd">        the highest Z-score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">embedding</span>
    <span class="n">nbr_sub</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="n">d_sub</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">nbr_sub</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="n">d_sub</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 

    <span class="c1"># 2) Z-score &amp; threshold</span>
    <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">d1</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;=</span> <span class="n">z_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">z</span><span class="p">))]</span>

    <span class="c1"># 3) rank by descending Z-score</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">locs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.identify_broken_box" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identify_broken_box</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Identify broken links using boxplot-based outlier detection within distance bins.</p>
<p>This helper function bins the true distances and identifies outliers in the
embedding distances within each bin using boxplot criteria.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dists</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with 'true' and 'embedding' distance columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IQR multiplier for outlier detection threshold.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbin</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins to divide the true distance range into.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Copy of input distances DataFrame with additional 'brokenness' boolean column
indicating which links are identified as broken outliers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">identify_broken_box</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify broken links using boxplot-based outlier detection within distance bins.</span>

<span class="sd">    This helper function bins the true distances and identifies outliers in the</span>
<span class="sd">    embedding distances within each bin using boxplot criteria.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dists : pd.DataFrame</span>
<span class="sd">        DataFrame with &#39;true&#39; and &#39;embedding&#39; distance columns.</span>
<span class="sd">    outlier_factor : float, default=3</span>
<span class="sd">        IQR multiplier for outlier detection threshold.</span>
<span class="sd">    nbin : int, default=10</span>
<span class="sd">        Number of bins to divide the true distance range into.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Copy of input distances DataFrame with additional &#39;brokenness&#39; boolean column</span>
<span class="sd">        indicating which links are identified as broken outliers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">boxplot_data</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">],</span> <span class="n">dists</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">],</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="p">)</span>
    <span class="n">brokenness</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">brokenness</span> <span class="o">=</span> <span class="n">brokenness</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">brokenness</span><span class="p">[</span><span class="s2">&quot;brokenness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">brokenness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;brokenness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">brokenness</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.identify_broken_window" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">identify_broken_window</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Identify broken links using sliding window smoothing and residual analysis.</p>
<p>This helper function applies a sliding window median filter to the distance
relationship and identifies links where the embedding distance significantly
exceeds the smoothed expectation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dists</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with 'true' and 'embedding' distance columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiplier for IQR-based outlier threshold in residual analysis.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>percentiles</code>
            </td>
            <td>
                  <code>list of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentiles used for IQR calculation.</p>
              </div>
            </td>
            <td>
                  <code>[75, 25]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame</code>
            </td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window frame size [before, after] for sliding median calculation.</p>
              </div>
            </td>
            <td>
                  <code>[50, 50]</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with original columns plus:
- 'embedding_smooth': smoothed embedding distances
- 'residual': difference between actual and smoothed embedding distances<br />
- 'brokenness': boolean indicating broken links</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">identify_broken_window</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify broken links using sliding window smoothing and residual analysis.</span>

<span class="sd">    This helper function applies a sliding window median filter to the distance</span>
<span class="sd">    relationship and identifies links where the embedding distance significantly</span>
<span class="sd">    exceeds the smoothed expectation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dists : pd.DataFrame</span>
<span class="sd">        DataFrame with &#39;true&#39; and &#39;embedding&#39; distance columns.</span>
<span class="sd">    outlier_factor : float, default=3</span>
<span class="sd">        Multiplier for IQR-based outlier threshold in residual analysis.</span>
<span class="sd">    percentiles : list of float, default=[75, 25]</span>
<span class="sd">        Percentiles used for IQR calculation.</span>
<span class="sd">    frame : list of int, default=[50, 50]</span>
<span class="sd">        Window frame size [before, after] for sliding median calculation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame with original columns plus:</span>
<span class="sd">        - &#39;embedding_smooth&#39;: smoothed embedding distances</span>
<span class="sd">        - &#39;residual&#39;: difference between actual and smoothed embedding distances  </span>
<span class="sd">        - &#39;brokenness&#39;: boolean indicating broken links</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">alt</span><span class="o">.</span><span class="n">Chart</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span><span class="o">.</span><span class="n">transform_window</span><span class="p">(</span>
        <span class="n">embedding_smooth</span><span class="o">=</span><span class="s1">&#39;median(embedding)&#39;</span><span class="p">,</span>
        <span class="n">sort</span><span class="o">=</span><span class="p">[</span><span class="n">alt</span><span class="o">.</span><span class="n">SortField</span><span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">)],</span>
        <span class="n">frame</span><span class="o">=</span><span class="n">frame</span>
    <span class="p">)</span><span class="o">.</span><span class="n">mark_line</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;true:Q&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;embedding_smooth:Q&#39;</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;embedding_smooth&quot;</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;brokenness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;residual&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;embedding_smooth&quot;</span><span class="p">]</span> <span class="o">+</span> \
        <span class="n">outlier_factor</span> <span class="o">*</span> <span class="n">iqr</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;residual&quot;</span><span class="p">],</span> <span class="n">percentiles</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.iqr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">iqr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Calculate the interquartile range between given percentiles.</p>
<p>This function computes the difference between two percentiles of the
input array, typically used to measure the spread of data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>x</code>
            </td>
            <td>
                  <code><span title="array">array</span> - <span title="like">like</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input array for which to calculate the interquartile range.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>percentiles</code>
            </td>
            <td>
                  <code>array-like of length 2</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Two percentile values (e.g., [25, 75] for standard IQR).
The function returns the difference between the higher and lower percentiles.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The interquartile range (difference between the specified percentiles).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">iqr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the interquartile range between given percentiles.</span>

<span class="sd">    This function computes the difference between two percentiles of the</span>
<span class="sd">    input array, typically used to measure the spread of data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array-like</span>
<span class="sd">        Input array for which to calculate the interquartile range.</span>
<span class="sd">    percentiles : array-like of length 2</span>
<span class="sd">        Two percentile values (e.g., [25, 75] for standard IQR).</span>
<span class="sd">        The function returns the difference between the higher and lower percentiles.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The interquartile range (difference between the specified percentiles).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.neighbor_generator" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neighbor_generator</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">broken_locations</span><span class="o">=</span><span class="p">[],</span> <span class="n">number_neighbor</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Generate neighbor lists for broken points in the embedding space.</p>
<p>This function finds nearest neighbors for specified broken points (or
automatically detected ones) in the embedding space. It's useful for
understanding the local neighborhood structure around problematic points.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>embedding</code>
            </td>
            <td>
                  <code>(<span title="array">array</span> - <span title="like">like</span>, <span title="shape">shape</span>(<span title="n_samples">n_samples</span>, <span title="n_features">n_features</span>))</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The embedding coordinates for all samples.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>broken_locations</code>
            </td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Indices of broken points for which to generate neighbors. If empty,
automatically detects broken points using broken_knn().</p>
              </div>
            </td>
            <td>
                  <code>[]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>number_neighbor</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of nearest neighbors to find for each broken point.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping broken point indices (int) to lists of their 
nearest neighbor indices, excluding the point itself.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neighbor_generator</span><span class="p">(</span><span class="n">embedding</span><span class="p">,</span> <span class="n">broken_locations</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">number_neighbor</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate neighbor lists for broken points in the embedding space.</span>

<span class="sd">    This function finds nearest neighbors for specified broken points (or</span>
<span class="sd">    automatically detected ones) in the embedding space. It&#39;s useful for</span>
<span class="sd">    understanding the local neighborhood structure around problematic points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    embedding : array-like, shape (n_samples, n_features)</span>
<span class="sd">        The embedding coordinates for all samples.</span>
<span class="sd">    broken_locations : list of int, default=[]</span>
<span class="sd">        Indices of broken points for which to generate neighbors. If empty,</span>
<span class="sd">        automatically detects broken points using broken_knn().</span>
<span class="sd">    number_neighbor : int, default=10</span>
<span class="sd">        Number of nearest neighbors to find for each broken point.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping broken point indices (int) to lists of their </span>
<span class="sd">        nearest neighbor indices, excluding the point itself.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">broken_locations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">broken_locations</span> <span class="o">=</span> <span class="n">broken_knn</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
    <span class="n">nbr_full</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">number_neighbor</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
    <span class="n">isolated</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">broken_locations</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">neigh</span> <span class="o">=</span> <span class="n">nbr_full</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">([</span><span class="n">embedding</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>
        <span class="n">isolated</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">neigh</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># drop self</span>
    <span class="k">return</span> <span class="n">isolated</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.neighborhood_distances" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neighborhood_distances</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">embed_key</span><span class="o">=</span><span class="s1">&#39;X_umap&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute pairwise distances between samples and their neighbors in both original and embedding spaces.</p>
<p>This function calculates pairwise distances between each sample and its
neighbors in the original high-dimensional space and compares them with
distances in the reduced embedding space. This is useful for analyzing
how well the embedding preserves local neighborhood structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adata</code>
            </td>
            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Annotated data matrix. Must contain a precomputed embedding (e.g., UMAP or t-SNE) in <code>obsm[embed_key]</code>
and a neighbor graph in <code>obsp["distances"]</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>embed_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key in <code>adata.obsm</code> where the embedding coordinates are stored.</p>
              </div>
            </td>
            <td>
                  <code>&#34;X_umap&#34;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with columns:
    - 'center': index of the sample (cell)
    - 'neighbor': index of the neighbor sample
    - 'true': distance in the original space (from <code>adata.obsp["distances"]</code>)
    - 'embedding': distance in the embedding space (from <code>adata.obsm[embed_key]</code>)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The number of neighbors is determined by the structure of the neighbor graph in <code>adata.obsp["distances"]</code>.
The function assumes that the embedding and neighbor graph have already been computed.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neighborhood_distances</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">embed_key</span><span class="o">=</span><span class="s2">&quot;X_umap&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute pairwise distances between samples and their neighbors in both original and embedding spaces.</span>

<span class="sd">    This function calculates pairwise distances between each sample and its</span>
<span class="sd">    neighbors in the original high-dimensional space and compares them with</span>
<span class="sd">    distances in the reduced embedding space. This is useful for analyzing</span>
<span class="sd">    how well the embedding preserves local neighborhood structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix. Must contain a precomputed embedding (e.g., UMAP or t-SNE) in `obsm[embed_key]`</span>
<span class="sd">        and a neighbor graph in `obsp[&quot;distances&quot;]`.</span>
<span class="sd">    embed_key : str, default=&quot;X_umap&quot;</span>
<span class="sd">        Key in `adata.obsm` where the embedding coordinates are stored.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame with columns:</span>
<span class="sd">            - &#39;center&#39;: index of the sample (cell)</span>
<span class="sd">            - &#39;neighbor&#39;: index of the neighbor sample</span>
<span class="sd">            - &#39;true&#39;: distance in the original space (from `adata.obsp[&quot;distances&quot;]`)</span>
<span class="sd">            - &#39;embedding&#39;: distance in the embedding space (from `adata.obsm[embed_key]`)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The number of neighbors is determined by the structure of the neighbor graph in `adata.obsp[&quot;distances&quot;]`.</span>
<span class="sd">    The function assumes that the embedding and neighbor graph have already been computed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">knn_graph</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsp</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span>
    <span class="n">dist_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="p">)):</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">knn_graph</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">knn_graph</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span>
            <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">embed_key</span><span class="p">][</span><span class="n">ix</span><span class="p">,</span> <span class="p">:]],</span> 
            <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">embed_key</span><span class="p">][</span><span class="n">neighbors</span><span class="p">,</span> <span class="p">:]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">),</span> 
            <span class="s2">&quot;neighbor&quot;</span><span class="p">:</span> <span class="n">neighbors</span><span class="p">,</span>
            <span class="s2">&quot;true&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
            <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">embedding</span>
        <span class="p">}))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dist_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.neighborhoods" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neighborhoods</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Identify broken neighborhoods in embeddings using different methods.</p>
<p>This function serves as the main interface for detecting broken neighborhoods
in dimensionality reduction embeddings. It supports multiple methods for
identifying outliers and broken links between original and embedding spaces.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adata</code>
            </td>
            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Annotated data matrix with precomputed embedding and neighbor graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Factor used to determine outlier threshold. Higher values are more
permissive (fewer outliers detected).</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Proportion threshold for flagging samples as having broken neighborhoods.
Centers with more than this proportion of broken neighbors are flagged.</p>
              </div>
            </td>
            <td>
                  <code>0.2  </code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Method for identifying broken neighborhoods. Options:
- "box": Uses boxplot-based outlier detection
- "window": Uses sliding window smoothing with residual analysis</p>
              </div>
            </td>
            <td>
                  <code>&#34;box&#34;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>percentiles</code>
            </td>
            <td>
                  <code>list of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentiles used for IQR calculation in windowing method.</p>
              </div>
            </td>
            <td>
                  <code>[75, 25]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame</code>
            </td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window frame size [before, after] for sliding window smoothing.</p>
              </div>
            </td>
            <td>
                  <code>[50, 50]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbin</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins for boxplot method.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>keyword arguments</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to neighborhood_distances().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping center indices to lists of their neighbor indices
for samples with broken neighborhoods.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="NotImplementedError">NotImplementedError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an unsupported method is specified.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neighborhoods</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
                  <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify broken neighborhoods in embeddings using different methods.</span>

<span class="sd">    This function serves as the main interface for detecting broken neighborhoods</span>
<span class="sd">    in dimensionality reduction embeddings. It supports multiple methods for</span>
<span class="sd">    identifying outliers and broken links between original and embedding spaces.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix with precomputed embedding and neighbor graph.</span>
<span class="sd">    outlier_factor : float, default=3</span>
<span class="sd">        Factor used to determine outlier threshold. Higher values are more</span>
<span class="sd">        permissive (fewer outliers detected).</span>
<span class="sd">    threshold : float, default=0.2  </span>
<span class="sd">        Proportion threshold for flagging samples as having broken neighborhoods.</span>
<span class="sd">        Centers with more than this proportion of broken neighbors are flagged.</span>
<span class="sd">    method : str, default=&quot;box&quot;</span>
<span class="sd">        Method for identifying broken neighborhoods. Options:</span>
<span class="sd">        - &quot;box&quot;: Uses boxplot-based outlier detection</span>
<span class="sd">        - &quot;window&quot;: Uses sliding window smoothing with residual analysis</span>
<span class="sd">    percentiles : list of float, default=[75, 25]</span>
<span class="sd">        Percentiles used for IQR calculation in windowing method.</span>
<span class="sd">    frame : list of int, default=[50, 50]</span>
<span class="sd">        Window frame size [before, after] for sliding window smoothing.</span>
<span class="sd">    nbin : int, default=10</span>
<span class="sd">        Number of bins for boxplot method.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Additional arguments passed to neighborhood_distances().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping center indices to lists of their neighbor indices</span>
<span class="sd">        for samples with broken neighborhoods.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError</span>
<span class="sd">        If an unsupported method is specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;box&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neighborhoods_box</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;window&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">neighborhoods_window</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Method </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> not implemented for broken neighborhood construction.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.neighborhoods_box" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neighborhoods_box</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Identify broken neighborhoods using boxplot-based outlier detection.</p>
<p>This method bins the true distances and computes boxplot statistics within
each bin. Links are considered broken if their embedding distance is an
outlier relative to other links with similar true distances.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adata</code>
            </td>
            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Annotated data matrix with precomputed embedding and neighbor graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IQR multiplier for boxplot outlier detection. Values beyond
Q1 - outlier_factor<em>IQR or Q3 + outlier_factor</em>IQR are outliers.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Proportion threshold for flagging samples as having broken neighborhoods.</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>nbin</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of bins to divide the true distance range into.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>keyword arguments</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to neighborhood_distances().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping center indices to lists of their neighbor indices
for samples with broken neighborhoods.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neighborhoods_box</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify broken neighborhoods using boxplot-based outlier detection.</span>

<span class="sd">    This method bins the true distances and computes boxplot statistics within</span>
<span class="sd">    each bin. Links are considered broken if their embedding distance is an</span>
<span class="sd">    outlier relative to other links with similar true distances.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix with precomputed embedding and neighbor graph.</span>
<span class="sd">    outlier_factor : float, default=3</span>
<span class="sd">        IQR multiplier for boxplot outlier detection. Values beyond</span>
<span class="sd">        Q1 - outlier_factor*IQR or Q3 + outlier_factor*IQR are outliers.</span>
<span class="sd">    threshold : float, default=0.2</span>
<span class="sd">        Proportion threshold for flagging samples as having broken neighborhoods.</span>
<span class="sd">    nbin : int, default=10</span>
<span class="sd">        Number of bins to divide the true distance range into.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Additional arguments passed to neighborhood_distances().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping center indices to lists of their neighbor indices</span>
<span class="sd">        for samples with broken neighborhoods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">neighborhood_distances</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">brokenness</span> <span class="o">=</span> <span class="n">identify_broken_box</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">threshold_links</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">brokenness</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.neighborhoods_window" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">neighborhoods_window</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Identify broken neighborhoods using window-based smoothing and residual analysis.</p>
<p>This method applies a sliding window median filter to the distance relationships
and identifies outliers based on residuals from the smoothed curve. Points with
large positive residuals indicate broken neighborhoods where embedding distances
are much larger than expected.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adata</code>
            </td>
            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Annotated data matrix with precomputed embedding and neighbor graph.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>outlier_factor</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Multiplier for IQR-based outlier threshold. Residuals greater than
median + outlier_factor * IQR are considered broken.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Proportion threshold for flagging samples as having broken neighborhoods.</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>percentiles</code>
            </td>
            <td>
                  <code>list of float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Percentiles used for IQR calculation in residual analysis.</p>
              </div>
            </td>
            <td>
                  <code>[75, 25]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>frame</code>
            </td>
            <td>
                  <code>list of int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Window frame size [before, after] for sliding median calculation.</p>
              </div>
            </td>
            <td>
                  <code>[50, 50]</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code>keyword arguments</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional arguments passed to neighborhood_distances().</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping center indices to lists of their neighbor indices
for samples with broken neighborhoods.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">neighborhoods_window</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify broken neighborhoods using window-based smoothing and residual analysis.</span>

<span class="sd">    This method applies a sliding window median filter to the distance relationships</span>
<span class="sd">    and identifies outliers based on residuals from the smoothed curve. Points with</span>
<span class="sd">    large positive residuals indicate broken neighborhoods where embedding distances</span>
<span class="sd">    are much larger than expected.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix with precomputed embedding and neighbor graph.</span>
<span class="sd">    outlier_factor : float, default=3</span>
<span class="sd">        Multiplier for IQR-based outlier threshold. Residuals greater than</span>
<span class="sd">        median + outlier_factor * IQR are considered broken.</span>
<span class="sd">    threshold : float, default=0.2</span>
<span class="sd">        Proportion threshold for flagging samples as having broken neighborhoods.</span>
<span class="sd">    percentiles : list of float, default=[75, 25]</span>
<span class="sd">        Percentiles used for IQR calculation in residual analysis.</span>
<span class="sd">    frame : list of int, default=[50, 50]</span>
<span class="sd">        Window frame size [before, after] for sliding median calculation.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Additional arguments passed to neighborhood_distances().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping center indices to lists of their neighbor indices</span>
<span class="sd">        for samples with broken neighborhoods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">neighborhood_distances</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">brokenness</span> <span class="o">=</span> <span class="n">identify_broken_window</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">outlier_factor</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">threshold_links</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">brokenness</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="distortions.geometry.neighborhoods.threshold_links" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">threshold_links</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">brokenness</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Flag samples with high proportions of broken neighborhood links.</p>
<p>This function identifies samples where the proportion of broken neighborhood
links exceeds a specified threshold, indicating problematic embedding regions.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dists</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing distance information with 'center' and 'neighbor' columns.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>brokenness</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with 'center' and 'brokenness' columns indicating broken links.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>threshold</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Proportion threshold for flagging samples. Centers with more than this
proportion of broken neighbors are included in the output.</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping center indices (int) to lists of their neighbor indices
for samples exceeding the brokenness threshold.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>distortions/geometry/neighborhoods.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">threshold_links</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">brokenness</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flag samples with high proportions of broken neighborhood links.</span>

<span class="sd">    This function identifies samples where the proportion of broken neighborhood</span>
<span class="sd">    links exceeds a specified threshold, indicating problematic embedding regions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dists : pd.DataFrame</span>
<span class="sd">        DataFrame containing distance information with &#39;center&#39; and &#39;neighbor&#39; columns.</span>
<span class="sd">    brokenness : pd.DataFrame</span>
<span class="sd">        DataFrame with &#39;center&#39; and &#39;brokenness&#39; columns indicating broken links.</span>
<span class="sd">    threshold : float, default=0.2</span>
<span class="sd">        Proportion threshold for flagging samples. Centers with more than this</span>
<span class="sd">        proportion of broken neighbors are included in the output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary mapping center indices (int) to lists of their neighbor indices</span>
<span class="sd">        for samples exceeding the brokenness threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">brokenness</span> <span class="o">=</span> <span class="n">brokenness</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">brokenness</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">summary_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)):</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">brokenness</span><span class="p">[</span><span class="n">brokenness</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">centers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="s2">&quot;brokenness&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
            <span class="n">brokenness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;brokenness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">summary_dict</span><span class="p">[</span><span class="n">centers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">dists</span><span class="p">[</span><span class="n">dists</span><span class="o">.</span><span class="n">center</span> <span class="o">==</span> <span class="n">centers</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">summary_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div><h2 id="distortionsvisualization"><code>distortions.visualization</code></h2>


<div class="doc doc-object doc-module">



<a id="distortions.visualization"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="distortions.visualization.dplot" class="doc doc-heading">
            <code>dplot</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="anywidget.AnyWidget">AnyWidget</span></code></p>


        <p>Interactive Distortion Plot Widget</p>
<p>This class provides an interactive widget for visualizing distortion metrics
computed on datasets, with a ggplot2-like syntax for adding graphical marks
and overlaying distortion criteria. It is designed for use in Jupyter
environments and leverages the anywidget and traitlets libraries for
interactivity. You can pause mouseover interactivity by holding down the
control key.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input dataset to visualize. Must be convertible to a list of records.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional positional arguments passed to the parent AnyWidget.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional keyword arguments passed to the parent AnyWidget and used as
visualization options.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="mapping(**kwargs) (distortions.visualization.dplot.mapping)" href="#distortions.visualization.dplot.mapping">mapping</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Specify the mapping from data columns to visual properties.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.geom_ellipse">geom_ellipse</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add an ellipse layer to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.geom_hair">geom_hair</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a hair (small oriented lines) layer to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.labs">labs</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add labels to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.geom_edge_link">geom_edge_link</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add edge link geometry to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.inter_edge_link">inter_edge_link</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add interactive edge link geometry to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.inter_isometry">inter_isometry</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add interactive isometry overlays to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.scale_color">scale_color</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a color scale to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.scale_size">scale_size</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add a size scale to the plot.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.inter_boxplot">inter_boxplot</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Add an interactive boxplot layer for distortion metrics, using provided
distance summaries and outlier information.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><span title="distortions.visualization.dplot.save">save</span></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Save the current view to SVG.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="o">...</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">mapping</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;embedding_1&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;embedding_2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">geom_ellipse</span><span class="p">()</span>
</code></pre></div>







              <details class="quote">
                <summary>Source code in <code>distortions/visualization/interactive.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">dplot</span><span class="p">(</span><span class="n">anywidget</span><span class="o">.</span><span class="n">AnyWidget</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interactive Distortion Plot Widget</span>

<span class="sd">    This class provides an interactive widget for visualizing distortion metrics</span>
<span class="sd">    computed on datasets, with a ggplot2-like syntax for adding graphical marks</span>
<span class="sd">    and overlaying distortion criteria. It is designed for use in Jupyter</span>
<span class="sd">    environments and leverages the anywidget and traitlets libraries for</span>
<span class="sd">    interactivity. You can pause mouseover interactivity by holding down the</span>
<span class="sd">    control key.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The input dataset to visualize. Must be convertible to a list of records.</span>
<span class="sd">    *args : tuple</span>
<span class="sd">        Additional positional arguments passed to the parent AnyWidget.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional keyword arguments passed to the parent AnyWidget and used as</span>
<span class="sd">        visualization options.</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    mapping(**kwargs)</span>
<span class="sd">        Specify the mapping from data columns to visual properties.</span>
<span class="sd">    geom_ellipse(**kwargs)</span>
<span class="sd">        Add an ellipse layer to the plot.</span>
<span class="sd">    geom_hair(**kwargs)</span>
<span class="sd">        Add a hair (small oriented lines) layer to the plot.</span>
<span class="sd">    labs(**kwargs)</span>
<span class="sd">        Add labels to the plot.</span>
<span class="sd">    geom_edge_link(**kwargs)</span>
<span class="sd">        Add edge link geometry to the plot.</span>
<span class="sd">    inter_edge_link(**kwargs)</span>
<span class="sd">        Add interactive edge link geometry to the plot.</span>
<span class="sd">    inter_isometry(**kwargs)</span>
<span class="sd">        Add interactive isometry overlays to the plot.</span>
<span class="sd">    scale_color(**kwargs)</span>
<span class="sd">        Add a color scale to the plot.</span>
<span class="sd">    scale_size(**kwargs)</span>
<span class="sd">        Add a size scale to the plot.</span>
<span class="sd">    inter_boxplot(dists, **kwargs)</span>
<span class="sd">        Add an interactive boxplot layer for distortion metrics, using provided</span>
<span class="sd">        distance summaries and outlier information.</span>
<span class="sd">    save(filename)</span>
<span class="sd">        Save the current view to SVG.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; df = pd.DataFrame({...})</span>
<span class="sd">    &gt;&gt;&gt; dplot(df).mapping(x=&#39;embedding_1&#39;, y=&#39;embedding_2&#39;).geom_ellipse()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">widget_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;widget&quot;</span>
    <span class="n">_esm</span> <span class="o">=</span> <span class="n">widget_dir</span> <span class="o">/</span> <span class="s2">&quot;render.js&quot;</span>
    <span class="n">_mapping</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">List</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">List</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">neighbors</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">List</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">distance_summaries</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">List</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">List</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Dict</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">elem_svg</span> <span class="o">=</span> <span class="n">traitlets</span><span class="o">.</span><span class="n">Unicode</span><span class="p">()</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">sync</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specify the Mapping </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="s2">&quot;angle&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;s1&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;s0&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">geom_ellipse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;geom_ellipse&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">geom_hair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;geom_hair&#39;</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">labs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;labs&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">geom_edge_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;geom_edge_link&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inter_edge_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;inter_edge_link&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inter_isometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;inter_isometry&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scale_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scale_color&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scale_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;scale_size&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inter_boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">summaries</span><span class="p">,</span> <span class="n">outliers</span> <span class="o">=</span> <span class="n">boxplot_data</span><span class="p">(</span><span class="n">dists</span><span class="p">[</span><span class="s2">&quot;true&quot;</span><span class="p">],</span> <span class="n">dists</span><span class="p">[</span><span class="s2">&quot;embedding&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">outliers</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
        <span class="n">outliers</span><span class="p">[</span><span class="s2">&quot;neighbor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">neighbor</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">outliers</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

        <span class="c1"># pass the related data to the visualization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">+</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;inter_boxplot&quot;</span><span class="p">,</span> <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">}]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_summaries</span> <span class="o">=</span> <span class="n">summaries</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outliers</span> <span class="o">=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;plot.svg&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;save&quot;</span><span class="p">})</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elem_svg</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="distortions.visualization.dplot.mapping" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mapping</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Specify the Mapping</p>


            <details class="quote">
              <summary>Source code in <code>distortions/visualization/interactive.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Specify the Mapping </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;angle&quot;</span><span class="p">:</span> <span class="s2">&quot;angle&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;s1&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="s2">&quot;s0&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_mapping</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="distortions.visualization.scanpy_umap" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">scanpy_umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">max_cells</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Runs UMAP visualization on an AnnData object with basic preprocessing.</p>
<p>This wrapper function filters genes by minimum count, applies log
transformation, selects highly variable genes, computes neighbors in PCA
space, and runs UMAP.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>adata</code>
            </td>
            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>AnnData experiment object containing the data to filter, transform, and
apply UMAP to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_cells</code>
            </td>
            <td>
                  <code>int, optional (default: 200)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of cells to use for visualization.</p>
              </div>
            </td>
            <td>
                  <code>200</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_neighbors</code>
            </td>
            <td>
                  <code>int, optional (default: 10)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of neighbors to use for constructing the neighborhood graph.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>n_pcs</code>
            </td>
            <td>
                  <code>int, optional (default: 40)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of principal components to use for neighborhood graph construction.</p>
              </div>
            </td>
            <td>
                  <code>40</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>adata</code></td>            <td>
                  <code><span title="anndata.AnnData">AnnData</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The AnnData object after preprocessing and UMAP computation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>The function modifies the input AnnData object in place.</p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">distortion.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">scanpy_umap</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">pbmc3k</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">adata_umap</span> <span class="o">=</span> <span class="n">scanpy_umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">max_cells</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata_umap</span><span class="p">)</span>
</code></pre></div>


            <details class="quote">
              <summary>Source code in <code>distortions/visualization/umap.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">scanpy_umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">max_cells</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs UMAP visualization on an AnnData object with basic preprocessing.</span>

<span class="sd">    This wrapper function filters genes by minimum count, applies log</span>
<span class="sd">    transformation, selects highly variable genes, computes neighbors in PCA</span>
<span class="sd">    space, and runs UMAP.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        AnnData experiment object containing the data to filter, transform, and</span>
<span class="sd">        apply UMAP to.</span>
<span class="sd">    max_cells : int, optional (default: 200)</span>
<span class="sd">        Maximum number of cells to use for visualization.</span>
<span class="sd">    n_neighbors : int, optional (default: 10)</span>
<span class="sd">        Number of neighbors to use for constructing the neighborhood graph.</span>
<span class="sd">    n_pcs : int, optional (default: 40)</span>
<span class="sd">        Number of principal components to use for neighborhood graph construction.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object after preprocessing and UMAP computation.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The function modifies the input AnnData object in place.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import scanpy as sc</span>
<span class="sd">    &gt;&gt;&gt; from distortion.visualization import scanpy_umap</span>
<span class="sd">    &gt;&gt;&gt; adata = sc.datasets.pbmc3k()</span>
<span class="sd">    &gt;&gt;&gt; adata_umap = scanpy_umap(adata, max_cells=100, n_neighbors=15, n_pcs=30)</span>
<span class="sd">    &gt;&gt;&gt; sc.pl.umap(adata_umap)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:</span><span class="n">max_cells</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Preprocess the dataset</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_counts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_mean</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">min_disp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span>

    <span class="c1"># Run UMAP</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="n">n_pcs</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>