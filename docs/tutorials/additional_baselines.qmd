---
# to compile: quarto render distortions/docs/tutorials/additional_baselines.qmd --execute-dir=.
title: Additional Evaluation Comparison
execute:
    message: false
    warning: false
    cache: true
---

```{r}
#| label: load-libraries
library(SingleCellExperiment)
library(zellkonverter)
library(fs)
library(glue)
library(neMDBD)
library(sleepwalk)
set.seed(20251025)
```

# PBMC Experiment

## Read Embeddings

These embeddings were created in `pbmc.ipynb`. To run more quickly, we've subsampled cells.

```{r}
#| label: read-pbmc
data_dir <- path("distortions/docs/tutorials/data/")
pbmc <- readH5AD(data_dir / "pbmc_with_umap.h5ad")
ix <- sample(nrow(X), 1e3)
pbmc <- pbmc[, ix]
```

We get the original assay and the UMAP embedding.

```{r}
X <- t(assay(pbmc))
Y <- int_colData(pbmc)$reducedDims$X_umap
```

## MDBD

```{r}
#| label: pbmc-pscore
t1 <- Sys.time()
pscore <- perturbation_score_compute(X, Y, 100, approx = 2)
Sys.time() - t1
data.frame(ix = ix, score = pscore) |>
    write_csv(data_dir/glue("pscore_pbmc.csv"))
```

## Sleepwalk

```{r}
#| label: sleepwalk-pbmc
sleepwalk(Y, X, saveToFile = "sleepwalk_pbmc.html")
```

# Two Clusters Simulation

These embeddings were created in `two_clusters.ipynb`.

```{r}
#| label: read-clusters
two_clusters <- readH5AD(data_dir / "two_clusters.h5ad")
X <- t(assay(two_clusters))
Y <- int_colData(two_clusters)$reducedDims$X_umap
```

## MDBD

```{r}
#| label: two-clusters-pscore
t1 <- Sys.time()
pscore <- perturbation_score_compute(X, Y, 100, approx = 2)
Sys.time() - t1
data.frame(score = pscore) |>
    write_csv(data_dir/glue("p_score_two_clusters.csv"))
```

## Sleepwalk

```{r}
#| label: two-clusters-sleepwalk
sleepwalk(Y, X, saveToFile = "sleepwalk_two_clusters.html")
```
